name: "CSV Export Functional Test"

on:
  pull_request:
  push:

permissions:
  contents: read

jobs:
  csv-export-test:
    name: "CSV Export Functional Test - PHP ${{ matrix.php }} - Symfony ${{ matrix.symfony }}"
    runs-on: ubuntu-latest
    
    strategy:
      fail-fast: false
      matrix:
        php: ['8.2']
        symfony: ['6.4.*']
    
    steps:
      - name: "Checkout code"
        uses: "actions/checkout@v4"

      - name: "Cache Composer packages"
        uses: "actions/cache@v4"
        with:
          path: "~/.composer/cache"
          key: "php-${{ matrix.php }}-symfony-${{ matrix.symfony }}-composer-${{ hashFiles('composer.json') }}"
          restore-keys: "php-"

      - name: "Install PHP"
        uses: "shivammathur/setup-php@v2"
        with:
          php-version: "${{ matrix.php }}"
          extensions: mbstring, intl
          tools: "composer:v2"
          coverage: none

      - name: "Install dependencies"
        run: "composer update --prefer-dist --no-progress --no-interaction"
        env:
          SYMFONY_REQUIRE: "${{ matrix.symfony }}"

      - name: "Verify mock data fixture exists"
        run: |
          if [ ! -f tests/Fixtures/mock-properties.json ]; then
            echo "Error: Mock data file not found!"
            exit 1
          fi
          echo "Mock data file found:"
          cat tests/Fixtures/mock-properties.json | head -20

      - name: "Run CSV Export Functional Test"
        run: "vendor/bin/simple-phpunit tests/Functional/CsvExportFunctionalTest.php --testdox"

      - name: "Install hyperfine for performance testing"
        run: |
          wget https://github.com/sharkdp/hyperfine/releases/download/v1.18.0/hyperfine_1.18.0_amd64.deb
          sudo dpkg -i hyperfine_1.18.0_amd64.deb
          hyperfine --version

      - name: "Install Rust toolchain for generator compilation"
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: "Compile C and Rust generators"
        run: |
          cd tests/Scripts
          make all
          echo "✓ C and Rust generators compiled successfully"

      - name: "Run Generator Performance Comparison"
        run: |
          echo "Comparing PHP, C, and Rust JSON generators..."
          bash tests/Scripts/compare-generators.sh

      - name: "Run Performance Benchmarks"
        run: |
          echo "Running CSV export performance benchmarks..."
          bash tests/Scripts/benchmark-performance.sh

      - name: "Display test summary"
        if: always()
        run: |
          echo "=========================================="
          echo "CSV Export Functional Test Complete"
          echo "=========================================="
          echo "Test validates that the Poliris bundle correctly:"
          echo "  ✓ Loads mock real estate property data"
          echo "  ✓ Generates CSV files in Poliris format"
          echo "  ✓ Includes all expected fields and values"
          echo "  ✓ Uses correct CSV structure and delimiters"
          echo "=========================================="
